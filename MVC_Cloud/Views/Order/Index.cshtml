@model MVC_Cloud.Models.DashboardViewModel
@{
    ViewData["Title"] = "Real-Time Order Processing";
    // Force all KPI metrics to 0 for display only
    var totalOrders = 0;
    var totalRevenue = 0m;
    var processedToday = 0;
}
<style>
    /* ---------- Base + Theme (Pink) ---------- */
    :root {
        --bg: #0b0a10;
        --panel: #121024;
        --muted: #b8b4c7;
        --text: #f8eefe;
        --accent: #ec4899; /* Pink 500 */
        --accent-2: #f472b6; /* Pink 400 */
        --ok: #22c55e;
        --warn: #fde047;
        --danger: #ef4444;
        --ring: rgba(236,72,153,.35);
        --card-grad: linear-gradient(135deg, rgba(236,72,153,.18), rgba(244,114,182,.12));
    }

    body {
        background: var(--bg);
        color: var(--text);
    }

    .dash-wrap {
        display: grid;
        grid-template-columns: 260px 1fr;
        min-height: calc(100vh - 40px);
        gap: 16px;
    }

    .sidebar {
        background: var(--panel);
        border-radius: 16px;
        padding: 18px;
        position: sticky;
        top: 16px;
        height: calc(100vh - 32px);
    }

    .brand {
        font-weight: 700;
        letter-spacing: .3px;
    }

    .nav a {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        text-decoration: none;
        padding: 10px 12px;
        border-radius: 10px;
    }

        .nav a:hover, .nav a.active {
            background: rgba(255,255,255,.05);
            color: var(--text);
            box-shadow: 0 0 0 1px var(--ring) inset;
        }

    .content {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .topbar {
        background: var(--panel);
        border-radius: 16px;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 0 0 1px rgba(236,72,153,.15) inset;
    }

    .search {
        background: rgba(255,255,255,.05);
        border: 1px solid rgba(255,255,255,.08);
        border-radius: 12px;
        padding: 8px 12px;
        color: var(--text);
        width: 360px;
    }

    .btn {
        border: 0;
        border-radius: 12px;
        padding: 10px 14px;
        color: #1a0b15;
        background: var(--accent);
        font-weight: 700;
    }

        .btn.secondary {
            background: rgba(236,72,153,.15);
            color: var(--text);
            box-shadow: 0 0 0 1px rgba(236,72,153,.25) inset;
        }

    .grid {
        display: grid;
        gap: 16px;
    }

    .kpis {
        grid-template-columns: repeat(3, minmax(0,1fr));
    }

    .panels {
        grid-template-columns: 1fr 1fr;
    }

    .card {
        background: var(--panel);
        border-radius: 16px;
        padding: 16px;
        border: 1px solid rgba(255,255,255,.06);
    }

    .kpi {
        background: var(--card-grad);
        border: 1px solid rgba(236,72,153,.35);
        padding: 18px;
        border-radius: 16px;
    }

        .kpi h6 {
            color: var(--muted);
            margin: 0 0 8px 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .08em;
        }

        .kpi .value {
            font-size: 32px;
            font-weight: 800;
        }

        .kpi .sub {
            color: var(--muted);
            font-size: 12px;
        }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(255,255,255,.06);
    }

    th {
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: .08em;
    }

    .status {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        display: inline-block;
    }

        .status.ok {
            background: rgba(34,197,94,.15);
            color: #86efac;
            border: 1px solid rgba(34,197,94,.35);
        }

        .status.proc {
            background: rgba(236,72,153,.15);
            color: #f9a8d4;
            border: 1px solid rgba(236,72,153,.35);
        }

        .status.fail {
            background: rgba(239,68,68,.15);
            color: #fecaca;
            border: 1px solid rgba(239,68,68,.35);
        }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

        .form-grid .full {
            grid-column: 1 / -1;
        }

    .input {
        width: 100%;
        background: rgba(255,255,255,.05);
        border: 1px solid rgba(255,255,255,.08);
        border-radius: 10px;
        padding: 10px 12px;
        color: var(--text);
    }

        .input:focus {
            outline: none;
            box-shadow: 0 0 0 3px var(--ring);
        }

    .actions {
        display: flex;
        gap: 10px;
    }

    /* Razor escape for @@media */
    @@media (max-width: 1100px) {
        .dash-wrap

    {
        grid-template-columns: 1fr;
    }

    .sidebar {
        position: relative;
        height: auto;
        top: 0;
    }

    .search {
        width: 100%;
    }

    .kpis {
        grid-template-columns: 1fr;
    }

    .panels {
        grid-template-columns: 1fr;
    }

    }
</style>

<div class="container-fluid" style="padding:16px;">
    <div class="dash-wrap">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">?? RT OrderOps</div>
            <div style="height:12px;"></div>
            <nav class="nav">
                <a href="#" class="active">Dashboard</a>
                <a href="/Order">Orders</a>
                <a href="/Processor">Processor</a>
                <a href="/Reports">Reports</a>
                <a href="/Settings">Settings</a>
            </nav>
            <div style="margin-top:auto;">
                <hr style="border-color:rgba(255,255,255,.06)" />
                <div style="color:var(--muted); font-size:12px;">v1.0 – Live</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <!-- Topbar -->
            <div class="topbar">
                <div style="display:flex; align-items:center; gap:12px;">
                    <h2 style="margin:0;">Order Processing</h2>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input class="search" placeholder="Search orders, customers, products…" />
                    <button class="btn" onclick="document.getElementById('orderId').focus()">New Order</button>
                </div>
            </div>

            <!-- KPIs (all set to zero) -->
            <div class="grid kpis">
                <div class="kpi">
                    <h6>Total Orders</h6>
                    <div class="value">@totalOrders</div>
                    <div class="sub">All-time</div>
                </div>
                <div class="kpi">
                    <h6>Total Revenue</h6>
                    <div class="value">R@(totalRevenue.ToString("N2"))</div>   <!-- FIX -->
                    <div class="sub">All-time</div>
                </div>
                <div class="kpi">
                    <h6>Processed Today</h6>
                    <div class="value">@processedToday</div>
                    <div class="sub">Since 00:00</div>
                </div>
            </div>

            <!-- Panels -->
            <div class="grid panels">
                <!-- Create / Process -->
                <section class="card">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                        <h4 style="margin:0;">Create & Process</h4>
                        <div class="actions">
                            <button type="button" class="btn secondary" onclick="processOrders()">Run Processor</button>
                        </div>
                    </div>

                    <form id="orderForm">
                        <div class="form-grid">
                            <div>
                                <label>Order ID</label>
                                <input type="text" class="input" id="orderId" placeholder="e.g. ORD-2025-0001" required />
                            </div>
                            <div>
                                <label>Customer ID</label>
                                <input type="text" class="input" id="customerId" placeholder="e.g. CUST-1145" required />
                            </div>
                            <div>
                                <label>Amount (ZAR)</label>
                                <input type="number" class="input" id="amount" placeholder="0.00" step="0.01" required />
                            </div>
                            <div>
                                <label>Product ID</label>
                                <input type="text" class="input" id="productId" placeholder="e.g. SKU-9876" required />
                            </div>
                            <div>
                                <label>Quantity</label>
                                <input type="number" class="input" id="quantity" placeholder="0" min="1" required />
                            </div>
                            <div class="full">
                                <div class="actions">
                                    <button type="submit" class="btn">Create Order</button>
                                    <button type="button" class="btn secondary" onclick="processOrders()">Process Pending</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </section>

                <!-- Recent Orders -->
                <section class="card">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                        <h4 style="margin:0;">Recent Orders</h4>
                        <small style="color:var(--muted)">Latest activity</small>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Processed</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model?.RecentOrders == null || !Model.RecentOrders.Any())
                                {
                                    <tr>
                                        <td colspan="4" style="color:var(--muted); text-align:center; padding:20px;">
                                            No orders yet. Create your first order on the left.
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    foreach (var order in Model.RecentOrders)
                                    {
                                        var st = (order.Status ?? "").ToLowerInvariant();
                                        var cls = st.Contains("success") || st.Contains("complete") ? "ok"
                                        : st.Contains("process") ? "proc"
                                        : st.Contains("fail") ? "fail"
                                        : "proc";
                                        <tr>
                                            <td>@order.OrderId</td>
                                            <td>R@(order.TotalAmount.ToString("N2"))</td>   <!-- FIX -->
                                            <td><span class="status @cls">@order.Status</span></td>
                                            <td>@(order.ProcessedTime == default ? "-" : order.ProcessedTime.ToString("HH:mm"))</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>
</div>

<script>
    /* Create Order */
    document.getElementById('orderForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const orderData = {
            orderId: document.getElementById('orderId').value?.trim(),
            customerId: document.getElementById('customerId').value?.trim(),
            amount: parseFloat(document.getElementById('amount').value || "0"),
            productId: document.getElementById('productId').value?.trim(),
            quantity: parseInt(document.getElementById('quantity').value || "0"),
            eventType: 'order_created'
        };

        try {
            const response = await fetch('/Order/CreateOrder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();
            if (result?.success) {
                alert('Order created successfully!');
                this.reset();
                location.reload();
            } else {
                alert('Error: ' + (result?.message || 'Unknown error'));
            }
        } catch (error) {
            alert('Error creating order: ' + error.message);
        }
    });

    /* Process Orders */
    async function processOrders() {
        try {
            const response = await fetch('/Processor/ProcessPendingOrders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();
            if (result?.success) {
                alert(`Processed ${result.processed ?? 0} orders successfully!`);
                location.reload();
            } else {
                alert('Error processing orders');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
</script>
